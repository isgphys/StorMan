#!/usr/bin/env perl
use JSON;
use Date::Parse;

my $mount_arg = $ARGV[0];
my %scrub_status;

my @mounts = split('#', $mount_arg);

foreach my $mount ( @mounts ) {
    my $output     = `/sbin/btrfs scrub status $mount`;
    my $statustext = "unknown";
    my $status     = "0";
    my $stats      = "unknown";
    my $css_class  = "";

    my ($statustext, $stats) = $output =~ m/\n\t(.*)\n\t(.*)$/;
    chomp $statustext;
    chomp $stats;
    my ($starttime) = $statustext =~ m/at (\w{3} \w{3}\s+\d+ \d+:\d+:\d+ \d{4})/;
    $starttime = str2time($starttime);

    if ( $statustext =~ m/no stats available/) {
        $statustext = "-";
        $stats  = "";
    } elsif ($output =~ m/running/s) {
        $css_class = "running";
        $status    = "3";
    } elsif ($output =~ m/finished/s) {
        $css_class = "finished";
        $status    = "1";
    } elsif ($output =~ m/aborted/s) {
        $css_class = "aborted";
        $status    = "2";
    }


    $scrub_status{$mount} = {
        'statustext' => $statustext,
        'status'     => $status,
        'starttime'  => $starttime,
        'stats'      => $stats,
        'css_class'  => $css_class,
    };
}

my $json = JSON->new->allow_nonref;
my $json_text = $json->encode(\%scrub_status);
print "$json_text";
