#!/usr/bin/env perl
use JSON;

my $mount_arg = $ARGV[0];
my %scrub_status;

my @mounts = split('#', $mount_arg);

foreach my $mount ( @mounts ) {
    my $output    = `/sbin/btrfs scrub status $mount`;
    my $status    = "unknown";
    my $css_class = "";

#    if ( $output =~ m/No balance found/) {
#        $status = "-";
#    } elsif ($output =~ m/is running\n(.*)$/s) {
#        $status  = $1;
#        $css_class = "running";
#    } elsif ($output =~ m/is running, (.*)$/s) {
#        $status  = $1;
#        $status =~ s/,//;
#        $css_class = "requested";
#    } elsif ($output =~ m/is paused\n(.*)$/s) {
#        $status  = $1 . " (paused)";
#        $css_class = "paused";
#    }

    my ($status, $stats) = $output =~ m/\n\t(.*)\n\t(.*)$/;

    chomp $status;
    chomp $stats;

    $scrub_status{$mount} = {
        'status'    => $status,
        'stats'     => $stats,
        'css_class' => $css_class,
    };
}

my $json = JSON->new->allow_nonref;
my $json_text = $json->encode(\%scrub_status);
print "$json_text";
