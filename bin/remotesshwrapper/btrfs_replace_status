#!/usr/bin/env perl
use 5.010;
use strict;
use warnings;

use JSON;

my $BTRFS = "/usr/bin/btrfs";

my %replace_stats;
my $mountpts_ref = from_json($ARGV[0]);
my @mountpts = @{ $mountpts_ref };

foreach my $mount ( @mountpts ) {
    next unless $mount =~ m/^[a-zA-Z0-9_\-\/]+$/;
    my $status     = `$BTRFS replace status -1 $mount`;
    chomp $status;
    next unless $status =~ m/\%/;
    my ($value) = $status =~ /^([0-9.]+)/;

    # fix wrong progress value, BUG in btrfs-progs?
    $value = sprintf("%.2f\%",($value / 3.6));
    $status =~ s/^([0-9.\%]+)/$value/;
    #

    $replace_stats{$mount} = {
        'status'   => $status,
        'progress' => $value,
    };
}

print to_json(\%replace_stats);
